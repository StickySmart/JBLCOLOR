<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>JBL Farbwert-Auswertung</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; background: #f5f5f5; }
    #canvas { border: 1px solid #000; margin-top: 1em; max-width: 100%; height: auto; touch-action: none; }
    .output { margin-top: 1em; }
    #saveButton, #exportButton { margin-top: 1em; padding: 0.5em 1em; font-size: 1em; }
    #log { margin-top: 1em; white-space: pre-line; background: #fff; padding: 1em; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>JBL Farbwert-Auswertung (N, P, K)</h2>
  <input type="file" id="upload" accept="image/*"><br>
  <label for="testType">Test wählen:</label>
  <select id="testType">
    <option value="Nitrat (NO3)">Nitrat (NO3)</option>
    <option value="Phosphat (PO4)">Phosphat (PO4)</option>
    <option value="Kalium (K)">Kalium (K)</option>
  </select>
  <canvas id="canvas"></canvas>
  <div class="output">
    <p><strong>RGB:</strong> <span id="rgb">---</span></p>
    <p><strong>HEX:</strong> <span id="hex">---</span></p>
    <p><strong>Nächstliegender Tabellenwert:</strong> <span id="nearest">---</span></p>
    <p><strong>Interpolierter Wert:</strong> <span id="interpolated">---</span></p>
    <button id="saveButton">Messung speichern</button>
    <button id="exportButton">CSV herunterladen</button>
    <div id="log"></div>
  </div>
  <script>
    const jblColors = [
      { test: 'Kalium (K)', value: 10, rgb: [230, 210, 180] },
      { test: 'Kalium (K)', value: 20, rgb: [200, 180, 140] },
      { test: 'Kalium (K)', value: 30, rgb: [170, 150, 110] },
      { test: 'Nitrat (NO3)', value: 0.5, rgb: [137, 146, 141] },
      { test: 'Nitrat (NO3)', value: 1, rgb: [161, 170, 167] },
      { test: 'Nitrat (NO3)', value: 5, rgb: [169, 179, 178] },
      { test: 'Nitrat (NO3)', value: 10, rgb: [175, 184, 183] },
      { test: 'Nitrat (NO3)', value: 20, rgb: [176, 185, 184] },
      { test: 'Nitrat (NO3)', value: 40, rgb: [172, 181, 182] },
      { test: 'Nitrat (NO3)', value: 80, rgb: [175, 187, 187] },
      { test: 'Nitrat (NO3)', value: 140, rgb: [171, 183, 183] },
      { test: 'Nitrat (NO3)', value: 220, rgb: [154, 163, 161] },
      { test: 'Nitrat (NO3)', value: 200, rgb: [93, 77, 61] },
      { test: 'Phosphat (PO4)', value: 0.02, rgb: [132, 144, 143] },
      { test: 'Phosphat (PO4)', value: 0.05, rgb: [137, 147, 146] },
      { test: 'Phosphat (PO4)', value: 0.1, rgb: [144, 154, 155] },
      { test: 'Phosphat (PO4)', value: 0.2, rgb: [137, 147, 148] },
      { test: 'Phosphat (PO4)', value: 0.4, rgb: [136, 146, 146] },
      { test: 'Phosphat (PO4)', value: 0.6, rgb: [150, 161, 161] },
      { test: 'Phosphat (PO4)', value: 0.8, rgb: [138, 150, 150] },
      { test: 'Phosphat (PO4)', value: 1.2, rgb: [142, 156, 157] },
      { test: 'Phosphat (PO4)', value: 1.8, rgb: [131, 135, 132] }
    ];

    const csvData = [];
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const testType = document.getElementById('testType');
    const rgbOutput = document.getElementById('rgb');
    const hexOutput = document.getElementById('hex');
    const interpolatedOutput = document.getElementById('interpolated');
    const nearestOutput = document.getElementById('nearest');
    const saveButton = document.getElementById('saveButton');
    const exportButton = document.getElementById('exportButton');
    const log = document.getElementById('log');
    let lastInterpolated = null;

    upload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          let w = img.width;
          let h = img.height;
          const maxW = 800;
          const maxH = 800;
          if (w > maxW || h > maxH) {
            const scale = Math.min(maxW / w, maxH / h);
            w = Math.round(w * scale);
            h = Math.round(h * scale);
          }
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    canvas.addEventListener('click', function (e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const pixel = ctx.getImageData(x, y, 1, 1).data;
      const rgb = [pixel[0], pixel[1], pixel[2]];
      ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.strokeStyle = "red";
      ctx.lineWidth = 2;
      ctx.stroke();
      rgbOutput.textContent = rgb.join(', ');
      hexOutput.textContent = rgbToHex(...rgb);
      const selectedTest = testType.value;
      const interpolated = interpolateValue(rgb, selectedTest);
      const nearest = findClosestMatch(rgb, selectedTest);
      interpolatedOutput.textContent = `${selectedTest} ≈ ${interpolated.toFixed(2)} mg/l`;
      nearestOutput.textContent = `${nearest.value} mg/l`;
      lastInterpolated = { test: selectedTest, value: interpolated.toFixed(2) };
    });

    saveButton.addEventListener('click', () => {
      if (!lastInterpolated) return;
      const now = new Date();
      const timestamp = now.toLocaleString();
      csvData.push([timestamp, lastInterpolated.test, lastInterpolated.value]);
      log.textContent += `${timestamp} | ${lastInterpolated.test} ≈ ${lastInterpolated.value} mg/l
`;
    });

    exportButton.addEventListener('click', () => {
      const rows = [['Datum/Uhrzeit', 'Test', 'mg/l'], ...csvData];
      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "jbl_messprotokoll.csv");
      link.click();
    });

    function rgbToHex(r, g, b) {
      return "#" + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    function colorDistance(c1, c2) {
      return Math.sqrt(c1.reduce((acc, val, i) => acc + (val - c2[i]) ** 2, 0));
    }

    function findClosestMatch(rgb, testName) {
      const subset = jblColors.filter(c => c.test === testName);
      return subset.reduce((closest, current) => {
        const dist = colorDistance(rgb, current.rgb);
        return dist < colorDistance(rgb, closest.rgb) ? current : closest;
      });
    }

    function interpolateValue(rgb, testName) {
      const subset = jblColors.filter(c => c.test === testName).sort((a, b) => a.value - b.value);
      let bestPair = null;
      let minDistSum = Infinity;
      for (let i = 0; i < subset.length - 1; i++) {
        const dist1 = colorDistance(rgb, subset[i].rgb);
        const dist2 = colorDistance(rgb, subset[i + 1].rgb);
        const distSum = dist1 + dist2;
        if (distSum < minDistSum) {
          minDistSum = distSum;
          bestPair = [subset[i], subset[i + 1]];
        }
      }
      if (!bestPair) return subset[0].value;
      const [c1, c2] = bestPair;
      const d1 = colorDistance(rgb, c1.rgb);
      const d2 = colorDistance(rgb, c2.rgb);
      const weight = d2 / (d1 + d2);
      return c1.value * weight + c2.value * (1 - weight);
    }
  </script>
</body>
</html>
